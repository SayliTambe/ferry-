<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Promotions & Discounts</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      display: flex;
    }
    .sidebar {
      background-color: #333;
      color: white;
      width: 250px;
      padding-top: 20px;
      position: fixed;
      height: 100%;
    }
    .sidebar button {
      display: block;
      background-color: #444;
      color: white;
      border: none;
      width: 100%;
      padding: 15px;
      text-align: left;
      cursor: pointer;
      font-size: 1.2em;
      margin-bottom: 5px;
    }
    .sidebar button:hover {
      background-color: #555;
    }
    .submenu {
      display: none;
      background-color: #555;
    }
    .submenu button {
      background-color: #555;
      font-size: 1em;
      padding-left: 30px;
    }
    .submenu button:hover {
      background-color: #666;
    }
    .content {
      margin-left: 250px;
      padding: 20px;
      flex-grow: 1;
    }
    .header {
      background-image: url('ferry-banner.jpg');
      background-size: cover;
      color: white;
      text-align: center;
      padding: 50px 0;
    }
    .header h1 {
      margin: 0;
      font-size: 3em;
      color: #3498db; /* Light blue color */
    }
    .header p {
      font-size: 1.5em;
      color: #3498db; /* Light blue color */
    }
    .promotions {
      margin: 20px;
      display: none;
    }
    .promotion-table {
      width: 100%;
      border-collapse: collapse;
    }
    .promotion-table th, .promotion-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .promotion-table th {
      background-color: #f2f2f2;
      color: black;
    }
    .action-btn {
      background-color: #7dc6e9; /* Red color */
      color: white;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      margin: 20px auto;
      display: block;
      width: 200px;
      text-align: center;
    }
    .form-container, .code-list {
      display: none;
      flex-direction: column;
      align-items: center;
    }
    .form-container input {
      width: 300px;
      padding: 10px;
      margin: 5px 0;
    }
    .form-container button {
      width: 200px;
    }
    .code-list button {
      background-color: #77bae3; /* Red color */
      color: white;
      border: none;
      padding: 10px;
      margin: 5px 0;
      cursor: pointer;
      border-radius: 5px;
      width: 200px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <button onclick="toggleSubMenu()">Promotion</button>
    <div id="submenu" class="submenu">
      <button onclick="showAddPromotion()">Add Promotion</button>
      <button onclick="showPromotions()">View Promotions</button>
      <button onclick="showModifyPromotionOptions()">Modify Promotion</button>
      <button onclick="showDeletePromotionOptions()">Delete Promotion</button>
    </div>
  </div>
  <div class="content">
    <div class="header">
      <h1>Welcome to the Promotions and Discount Offers Management Page</h1>
      <p>Kindly Verify and Issue the Promotion Codes with Management Approval!</p>
    </div>
    <div id="promotionForm" class="form-container">
      <h2>Add a New Promotion</h2>
      <input type="text" id="promotionTitle" placeholder="Promotion Title">
      <input type="text" id="promotionCode" placeholder="Promotion Code">
      <input type="date" id="fromDate" placeholder="From Date">
      <input type="date" id="toDate" placeholder="To Date">
      <input type="number" id="percentage" placeholder="Discount Percentage">
      <button class="action-btn" onclick="addNewPromotion()">Add Promotion</button>
    </div>
    <div id="modifyForm" class="form-container">
      <h2>Modify Promotion</h2>
      <input type="text" id="modifyTitle" placeholder="Promotion Title">
      <input type="text" id="modifyCode" placeholder="Promotion Code" readonly>
      <input type="date" id="modifyFromDate" placeholder="From Date">
      <input type="date" id="modifyToDate" placeholder="To Date">
      <input type="number" id="modifyPercentage" placeholder="Discount Percentage">
      <button class="action-btn" onclick="saveModifiedPromotion()">Save Changes</button>
    </div>
    <div id="promotions" class="promotions">
      <table class="promotion-table">
        <thead>
          <tr>
            <th>Title</th>
            <th>Code</th>
            <th>From Date</th>
            <th>To Date</th>
            <th>Percentage</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="promotionTableBody">
          <!-- Promotions will be dynamically added here -->
        </tbody>
      </table>
    </div>
    <div id="codeList" class="code-list">
      <h2>Select a Promotion to Modify or Delete</h2>
      <!-- Promotion codes will be dynamically added here for modify/delete -->
    </div>
  </div>
  <script>
    function toggleSubMenu() {
      const submenu = document.getElementById('submenu');
      submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
    }

    function removePromoCode(button) {
      const row = button.parentElement.parentElement;
      const code = row.querySelector('.promotion-code').textContent;

      fetch(`/delete_promotion/${code}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
        showPromotions();
      })
      .catch(error => console.error('Error:', error));
    }

    function addNewPromotion() {
      const title = document.getElementById('promotionTitle').value;
      const code = document.getElementById('promotionCode').value;
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      const percentage = document.getElementById('percentage').value;

      if (title && code && fromDate && toDate && percentage) {
        const newPromotion = {
          title: title,
          code: code,
          from_date: fromDate,
          to_date: toDate,
          percentage: percentage
        };

        fetch('/add_promotion', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(newPromotion)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          document.getElementById('promotionTitle').value = '';
          document.getElementById('promotionCode').value = '';
          document.getElementById('fromDate').value = '';
          document.getElementById('toDate').value = '';
          document.getElementById('percentage').value = '';
          showPromotions();
        })
        .catch(error => console.error('Error:', error));
      } else {
        alert("All fields are required to add a new promotion.");
      }
    }

    function showAddPromotion() {
      hideAllSections();
      document.getElementById('promotionForm').style.display = 'flex';
    }

    function showPromotions() {
      hideAllSections();
      fetch('/promotions')
      .then(response => response.json())
      .then(data => {
        const promotionTableBody = document.getElementById('promotionTableBody');
        promotionTableBody.innerHTML = '';

        if (data.promotions.length === 0) {
          alert("No promotions available.");
          return;
        }

        data.promotions.forEach(promo => {
          const newRow = document.createElement('tr');
          newRow.innerHTML = `
            <td>${promo.title}</td>
            <td class="promotion-code">${promo.code}</td>
            <td>${promo.from_date}</td>
            <td>${promo.to_date}</td>
            <td>${promo.percentage}</td>
            <td><button class="remove-btn" onclick="removePromoCode(this)">Remove</button> <button class="modify-btn" onclick="populateModifyForm('${promo.title}', '${promo.code}', '${promo.from_date}', '${promo.to_date}', '${promo.percentage}')">Modify</button></td>
          `;
          promotionTableBody.appendChild(newRow);
        });

        document.getElementById('promotions').style.display = 'block';
      })
      .catch(error => console.error('Error:', error));
    }

    function populateModifyForm(title, code, fromDate, toDate, percentage) {
      document.getElementById('modifyTitle').value = title;
      document.getElementById('modifyCode').value = code;
      document.getElementById('modifyFromDate').value = fromDate;
      document.getElementById('modifyToDate').value = toDate;
      document.getElementById('modifyPercentage').value = percentage;
      showModifyForm();
    }

    function showModifyForm() {
      hideAllSections();
      document.getElementById('modifyForm').style.display = 'flex';
    }

    function saveModifiedPromotion() {
      const title = document.getElementById('modifyTitle').value;
      const code = document.getElementById('modifyCode').value;
      const fromDate = document.getElementById('modifyFromDate').value;
      const toDate = document.getElementById('modifyToDate').value;
      const percentage = document.getElementById('modifyPercentage').value;

      if (title && fromDate && toDate && percentage) {
        const modifiedPromotion = {
          title: title,
          from_date: fromDate,
          to_date: toDate,
          percentage: percentage
        };

        fetch(`/modify_promotion/${code}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(modifiedPromotion)
        })
        .then(response => response.json())
        .then(data => {
          alert(data.message);
          showPromotions();
        })
        .catch(error => console.error('Error:', error));
      } else {
        alert("All fields are required to modify the promotion.");
      }
    }

    function autoDeleteExpiredPromotions() {
      const today = new Date().toISOString().split('T')[0];
      const promotionTableBody = document.getElementById('promotionTableBody');
      const rows = promotionTableBody.querySelectorAll('tr');

      rows.forEach(row => {
        const toDate = row.querySelector('td:nth-child(4)').textContent;
        if (toDate < today) {
          const code = row.querySelector('.promotion-code').textContent;
          fetch(`/delete_promotion/${code}`, {
            method: 'DELETE'
          })
          .then(response => response.json())
          .then(data => {
            console.log(`Promotion with code ${code} deleted.`);
          })
          .catch(error => console.error('Error:', error));
        }
      });

      showPromotions();
    }

    function showModifyPromotionOptions() {
      hideAllSections();
      const codeListContainer = document.getElementById('codeList');
      codeListContainer.innerHTML = '';
      fetch('/promotions')
        .then(response => response.json())
        .then(data => {
          data.promotions.forEach(promo => {
            const button = document.createElement('button');
            button.textContent = `${promo.title} (${promo.code})`;
            button.onclick = () => populateModifyForm(promo.title, promo.code, promo.from_date, promo.to_date, promo.percentage);
            codeListContainer.appendChild(button);
          });
          codeListContainer.style.display = 'flex';
        })
        .catch(error => console.error('Error:', error));
    }

    function showDeletePromotionOptions() {
      hideAllSections();
      const codeListContainer = document.getElementById('codeList');
      codeListContainer.innerHTML = '';
      fetch('/promotions')
        .then(response => response.json())
        .then(data => {
          data.promotions.forEach(promo => {
            const button = document.createElement('button');
            button.textContent = `${promo.title} (${promo.code})`;
            button.onclick = () => removePromoCodeFromSidebar(promo.code);
            codeListContainer.appendChild(button);
          });
          codeListContainer.style.display = 'flex';
        })
        .catch(error => console.error('Error:', error));
    }

    function removePromoCodeFromSidebar(code) {
      fetch(`/delete_promotion/${code}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
        showPromotions();
      })
      .catch(error => console.error('Error:', error));
    }

    function hideAllSections() {
      document.getElementById('promotionForm').style.display = 'none';
      document.getElementById('modifyForm').style.display = 'none';
      document.getElementById('promotions').style.display = 'none';
      document.getElementById('codeList').style.display = 'none';
    }

    setInterval(autoDeleteExpiredPromotions, 24 * 60 * 60 * 1000); // Run once a day
  </script>
</body>
</html>
